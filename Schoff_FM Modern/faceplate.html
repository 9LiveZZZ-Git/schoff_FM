<!DOCTYPE html>

<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Schoffhauzer FM</title>
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        /* =================================================================
           CSS VARIABLES & THEMES
           ================================================================= */
        :root {
            --bg-void: #0c0c12;
            --bg-main: #14141c;
            --bg-panel: #1e1e28;
            --bg-control: #252530;
            --bg-knob: #18181f;
            --bg-knob-inner: #252530;
            --border: #3a3a4a;
            --border-light: #4a4a5a;
            --accent: #00f5a0;
            --accent2: #00d4aa;
            --accent3: #7c3aed;
            --text: #e0e0e0;
            --text-muted: #888;
            --glow: rgba(0, 245, 160, 0.4);
        }

    /* HEAVEN - Ethereal white, unsettling serenity */
    .theme-heaven {
        --bg-void: #f8f8ff;
        --bg-main: #ffffff;
        --bg-panel: #f0f0f8;
        --bg-control: #e8e8f0;
        --bg-knob: #e0e0e8;
        --bg-knob-inner: #d0d0d8;
        --border: #c0c0d0;
        --border-light: #d8d8e8;
        --accent: #8888aa;
        --accent2: #9999bb;
        --accent3: #7777aa;
        --text: #555566;
        --text-muted: #9999aa;
        --glow: rgba(150, 150, 200, 0.5);
    }
    .theme-heaven::before {
        content: '';
        position: fixed;
        inset: 0;
        background:
            radial-gradient(ellipse at 50% 0%, rgba(255,255,255,1) 0%, transparent 60%),
            radial-gradient(ellipse at 20% 50%, rgba(220,220,255,0.4) 0%, transparent 40%),
            radial-gradient(ellipse at 80% 50%, rgba(220,220,255,0.4) 0%, transparent 40%);
        pointer-events: none;
        z-index: 0;
        animation: heaven-shimmer 12s ease-in-out infinite;
    }
    @keyframes heaven-shimmer {
        0%, 100% { opacity: 0.8; }
        50% { opacity: 1; }
    }
    /* Unsettling slow pulse on main panel */
    .theme-heaven .synth-main {
        box-shadow: 0 0 80px rgba(200, 200, 255, 0.3), inset 0 0 60px rgba(255, 255, 255, 0.5);
        animation: heaven-breathe 10s ease-in-out infinite;
    }
    @keyframes heaven-breathe {
        0%, 100% { box-shadow: 0 0 80px rgba(200, 200, 255, 0.3), inset 0 0 60px rgba(255, 255, 255, 0.5); }
        50% { box-shadow: 0 0 120px rgba(200, 200, 255, 0.5), inset 0 0 80px rgba(255, 255, 255, 0.7); }
    }
    /* Ethereal fading text */
    .theme-heaven .logo {
        animation: heaven-fade 8s ease-in-out infinite;
        text-shadow: 0 0 20px rgba(150, 150, 200, 0.8), 0 0 40px rgba(200, 200, 255, 0.4);
    }
    @keyframes heaven-fade {
        0%, 100% { opacity: 0.7; letter-spacing: 3px; }
        50% { opacity: 1; letter-spacing: 4px; }
    }
    /* Ghostly LED - barely visible pulses */
    .theme-heaven .led {
        background: var(--accent);
        animation: heaven-led 6s ease-in-out infinite;
    }
    @keyframes heaven-led {
        0%, 100% { opacity: 0.3; box-shadow: 0 0 15px var(--glow); }
        50% { opacity: 0.7; box-shadow: 0 0 25px var(--glow); }
    }
    /* Knobs have subtle inner shadow for depth */
    .theme-heaven .knob-mid {
        box-shadow: inset 0 2px 8px rgba(0,0,0,0.1), 0 0 15px rgba(200, 200, 255, 0.2);
    }
    .theme-heaven .knob-mid:hover {
        box-shadow: inset 0 2px 8px rgba(0,0,0,0.1), 0 0 25px rgba(150, 150, 200, 0.5);
    }

    /* HELL - Inverse of Heaven: void black, ghostly pale accents */
    .theme-hell {
        --bg-void: #000000;
        --bg-main: #030303;
        --bg-panel: #080808;
        --bg-control: #0c0c0c;
        --bg-knob: #060606;
        --bg-knob-inner: #0a0a0a;
        --border: #151515;
        --border-light: #1a1a1a;
        --accent: #d0d0e0;
        --accent2: #a0a0b0;
        --accent3: #808090;
        --text: #c0c0d0;
        --text-muted: #505060;
        --glow: rgba(200, 200, 220, 0.15);
    }
    .theme-hell::before {
        content: '';
        position: fixed;
        inset: 0;
        background:
            radial-gradient(ellipse at 50% 100%, rgba(0,0,0,0.98) 0%, transparent 60%),
            radial-gradient(ellipse at 20% 50%, rgba(20,20,30,0.3) 0%, transparent 40%),
            radial-gradient(ellipse at 80% 50%, rgba(20,20,30,0.3) 0%, transparent 40%);
        pointer-events: none;
        z-index: 0;
        animation: hell-void 15s ease-in-out infinite;
    }
    @keyframes hell-void {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.85; }
    }
    /* Oppressive darkness breathing */
    .theme-hell .synth-main {
        box-shadow: 0 0 100px rgba(0,0,0,0.98), inset 0 0 50px rgba(0,0,0,0.8);
        animation: hell-breathe 8s ease-in-out infinite;
    }
    @keyframes hell-breathe {
        0%, 100% { box-shadow: 0 0 100px rgba(0,0,0,0.98), inset 0 0 50px rgba(0,0,0,0.8); }
        50% { box-shadow: 0 0 150px rgba(0,0,0,1), inset 0 0 80px rgba(0,0,0,0.9); }
    }
    /* Ghostly flickering text - unsettling */
    .theme-hell .logo {
        animation: hell-text-flicker 4s steps(3) infinite;
        text-shadow: 0 0 10px var(--glow);
    }
    @keyframes hell-text-flicker {
        0%, 100% { opacity: 0.9; transform: translateX(0); }
        10% { opacity: 0.4; }
        20% { opacity: 0.85; transform: translateX(-1px); }
        30% { opacity: 0.5; }
        40% { opacity: 0.9; transform: translateX(1px); }
        50% { opacity: 0.3; }
        60% { opacity: 0.8; }
        70% { opacity: 0.6; transform: translateX(-1px); }
        80% { opacity: 0.95; }
        90% { opacity: 0.4; transform: translateX(0); }
    }
    /* Barely visible LED - dying light */
    .theme-hell .led {
        background: var(--accent);
        animation: hell-led 5s ease-in-out infinite;
    }
    @keyframes hell-led {
        0%, 100% { opacity: 0.15; box-shadow: 0 0 5px var(--glow); }
        25% { opacity: 0.4; }
        50% { opacity: 0.1; box-shadow: 0 0 2px var(--glow); }
        75% { opacity: 0.3; }
    }
    /* Knobs sink into the void */
    .theme-hell .knob-mid {
        box-shadow: inset 0 3px 10px rgba(0,0,0,0.9), 0 0 5px rgba(200, 200, 220, 0.05);
    }
    .theme-hell .knob-mid:hover {
        box-shadow: inset 0 3px 10px rgba(0,0,0,0.9), 0 0 15px rgba(200, 200, 220, 0.1);
    }
    /* Panels have creepy vignette */
    .theme-hell .panel {
        box-shadow: inset 0 0 30px rgba(0,0,0,0.5);
    }

    /* DEATH - Corrupted, glitched, broken reality */
    .theme-death {
        --bg-void: #000000;
        --bg-main: #080808;
        --bg-panel: #0c0c0c;
        --bg-control: #101010;
        --bg-knob: #0a0505;
        --bg-knob-inner: #151010;
        --border: #2a1010;
        --border-light: #3a1515;
        --accent: #cc2020;
        --accent2: #20cc40;
        --accent3: #802020;
        --text: #aa2020;
        --text-muted: #661515;
        --glow: rgba(200, 40, 40, 0.6);
    }
    /* CRT scanlines overlay */
    .theme-death::before {
        content: '';
        position: fixed;
        inset: 0;
        background: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0,0,0,0.4) 2px, rgba(0,0,0,0.4) 4px);
        animation: scanlines 0.08s steps(2) infinite;
        pointer-events: none;
        z-index: 1000;
        opacity: 0.3;
    }
    @keyframes scanlines {
        0% { transform: translateY(0); }
        100% { transform: translateY(4px); }
    }
    /* Static noise overlay */
    .theme-death::after {
        content: '';
        position: fixed;
        inset: 0;
        background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
        opacity: 0.03;
        pointer-events: none;
        z-index: 999;
        animation: noise-flicker 0.15s steps(3) infinite;
    }
    @keyframes noise-flicker {
        0% { opacity: 0.03; }
        50% { opacity: 0.05; }
        100% { opacity: 0.02; }
    }
    /* Logo glitch */
    .theme-death .logo {
        animation: death-glitch 3s steps(1) infinite;
    }
    @keyframes death-glitch {
        0%, 85%, 100% { text-shadow: 0 0 10px var(--glow); transform: translateX(0) skewX(0deg); filter: none; }
        86% { text-shadow: -4px 0 var(--accent2), 4px 0 var(--accent); transform: translateX(-3px) skewX(-2deg); }
        88% { text-shadow: 4px 0 var(--accent2), -4px 0 var(--accent); transform: translateX(3px) skewX(2deg); filter: brightness(1.5); }
        90% { text-shadow: -2px 0 var(--accent2), 2px 0 var(--accent); transform: translateX(-1px) skewX(-1deg); }
        92% { text-shadow: 3px 0 var(--accent2), -3px 0 var(--accent); transform: translateX(2px) skewX(1deg); }
        94% { text-shadow: 0 -2px var(--accent2), 0 2px var(--accent); transform: translateY(-2px); filter: brightness(2); }
    }
    /* Panel glitch - random border flickers */
    .theme-death .panel {
        animation: panel-glitch 8s steps(1) infinite;
        box-shadow: inset 0 0 20px rgba(200, 40, 40, 0.1);
    }
    @keyframes panel-glitch {
        0%, 94%, 100% { border-color: var(--border); transform: translateX(0); }
        95% { border-color: var(--accent); transform: translateX(-1px); }
        96% { border-color: var(--accent2); transform: translateX(1px); }
        97% { border-color: var(--accent); }
    }
    /* Panel title glitch */
    .theme-death .panel-title {
        animation: title-glitch 6s steps(1) infinite;
    }
    @keyframes title-glitch {
        0%, 92%, 100% { text-shadow: 0 0 10px var(--glow); opacity: 1; }
        93% { text-shadow: -2px 0 var(--accent2), 2px 0 var(--accent); opacity: 0.8; }
        94% { text-shadow: 2px 0 var(--accent2), -2px 0 var(--accent); opacity: 0.9; }
        95% { text-shadow: 0 0 15px var(--accent); opacity: 0.7; }
    }
    /* Knob value glitch */
    .theme-death .knob-val {
        animation: val-glitch 5s steps(1) infinite;
    }
    @keyframes val-glitch {
        0%, 88%, 100% { text-shadow: none; transform: translateX(0); }
        89% { text-shadow: -1px 0 var(--accent2), 1px 0 var(--accent); transform: translateX(-1px); }
        91% { text-shadow: 1px 0 var(--accent2), -1px 0 var(--accent); transform: translateX(1px); }
        93% { color: var(--accent2); }
    }
    /* Knob indicator line glitch */
    .theme-death .knob-line {
        animation: line-glitch 4s steps(1) infinite;
    }
    @keyframes line-glitch {
        0%, 90%, 100% { box-shadow: 0 0 6px var(--glow); background: var(--accent); }
        91% { box-shadow: 0 0 12px var(--accent2); background: var(--accent2); }
        93% { box-shadow: 0 0 8px var(--accent); background: var(--accent); }
        95% { box-shadow: 0 0 15px var(--accent2); background: var(--accent2); }
    }
    /* Wave button glitch */
    .theme-death .wave-btn {
        animation: btn-glitch 7s steps(1) infinite;
    }
    .theme-death .wave-btn:nth-child(odd) {
        animation-delay: -2s;
    }
    .theme-death .wave-btn:nth-child(even) {
        animation-delay: -4s;
    }
    @keyframes btn-glitch {
        0%, 93%, 100% { transform: translateX(0); border-color: var(--border); }
        94% { transform: translateX(-2px); border-color: var(--accent); }
        96% { transform: translateX(2px); border-color: var(--accent2); }
    }
    /* Active wave button intense glitch */
    .theme-death .wave-btn-active {
        animation: btn-active-glitch 2s steps(1) infinite;
    }
    @keyframes btn-active-glitch {
        0%, 85%, 100% { box-shadow: 0 0 10px var(--glow); }
        86% { box-shadow: -3px 0 10px var(--accent), 3px 0 10px var(--accent2); transform: translateX(-1px); }
        88% { box-shadow: 3px 0 10px var(--accent), -3px 0 10px var(--accent2); transform: translateX(1px); }
        90% { box-shadow: 0 0 20px var(--accent2); }
    }
    /* Select dropdown glitch */
    .theme-death .styled-select {
        animation: select-glitch 9s steps(1) infinite;
    }
    @keyframes select-glitch {
        0%, 91%, 100% { border-color: var(--border); }
        92% { border-color: var(--accent); box-shadow: -2px 0 0 var(--accent2); }
        94% { border-color: var(--accent2); box-shadow: 2px 0 0 var(--accent); }
    }
    /* LED death pulse */
    .theme-death .led {
        animation: led-death 1.5s steps(1) infinite;
    }
    @keyframes led-death {
        0%, 70%, 100% { background: var(--accent); box-shadow: 0 0 8px var(--glow); opacity: 1; }
        72% { background: var(--accent2); box-shadow: 0 0 15px rgba(32, 204, 64, 0.8); }
        75% { background: var(--accent); opacity: 0.5; }
        78% { background: var(--accent2); opacity: 1; box-shadow: 0 0 20px rgba(32, 204, 64, 0.8); }
        80% { opacity: 0.3; }
    }
    /* FX title glitch */
    .theme-death .fx-title {
        animation: fx-glitch 5s steps(1) infinite;
    }
    @keyframes fx-glitch {
        0%, 87%, 100% { text-shadow: none; transform: translateX(0); }
        88% { text-shadow: -2px 0 var(--accent), 2px 0 var(--accent2); transform: translateX(-1px) skewX(-3deg); }
        90% { text-shadow: 2px 0 var(--accent), -2px 0 var(--accent2); transform: translateX(1px) skewX(3deg); }
        92% { color: var(--accent); }
    }
    /* Scope container glitch */
    .theme-death .scope-container {
        animation: scope-glitch 6s steps(1) infinite;
    }
    @keyframes scope-glitch {
        0%, 89%, 100% { border-color: var(--border); }
        90% { border-color: var(--accent); box-shadow: inset 0 0 20px rgba(200, 40, 40, 0.3); }
        92% { border-color: var(--accent2); box-shadow: inset 0 0 20px rgba(32, 204, 64, 0.3); }
        94% { border-color: var(--accent); transform: translateX(-1px); }
    }
    /* Main synth container corruption */
    .theme-death .synth-main {
        animation: synth-corrupt 10s steps(1) infinite;
    }
    @keyframes synth-corrupt {
        0%, 96%, 100% { box-shadow: none; filter: none; }
        97% { box-shadow: -3px 0 0 var(--accent), 3px 0 0 var(--accent2); filter: brightness(1.1); }
        98% { box-shadow: 3px 0 0 var(--accent), -3px 0 0 var(--accent2); filter: brightness(0.9); }
        99% { box-shadow: 0 -2px 0 var(--accent), 0 2px 0 var(--accent2); filter: contrast(1.2); }
    }
    /* Knob outer ring glitch */
    .theme-death .knob-outer {
        animation: knob-outer-glitch 7s steps(1) infinite;
    }
    @keyframes knob-outer-glitch {
        0%, 92%, 100% { border-color: var(--border); }
        93% { border-color: var(--accent); }
        95% { border-color: var(--accent2); }
    }
    /* Header glitch */
    .theme-death .header {
        animation: header-glitch 8s steps(1) infinite;
    }
    @keyframes header-glitch {
        0%, 95%, 100% { border-color: var(--border); }
        96% { border-color: var(--accent); background: linear-gradient(90deg, var(--bg-main) 0%, rgba(200,40,40,0.1) 50%, var(--bg-main) 100%); }
        98% { border-color: var(--accent2); background: linear-gradient(90deg, var(--bg-main) 0%, rgba(32,204,64,0.1) 50%, var(--bg-main) 100%); }
    }

    /* =================================================================
       BASE STYLES
       ================================================================= */
    body {
        margin: 0;
        padding: 12px;
        font-family: 'Inter', Tahoma, Arial, sans-serif;
        font-size: 11px;
        background: var(--bg-void);
        color: var(--text);
        position: relative;
        z-index: 1;
    }

    table { border-collapse: collapse; }

    /* =================================================================
       PANEL STYLES
       ================================================================= */
    .panel {
        background: var(--bg-panel);
        border: 1px solid var(--border);
        border-top-color: var(--border-light);
        border-left-color: var(--border-light);
        padding: 10px;
        margin: 3px;
    }

    .panel-title {
        color: var(--accent);
        font-weight: bold;
        font-size: 10px;
        letter-spacing: 2px;
        margin-bottom: 8px;
        padding-bottom: 5px;
        border-bottom: 1px solid var(--border);
        font-family: 'Share Tech Mono', monospace;
        text-transform: uppercase;
        text-shadow: 0 0 10px var(--glow);
    }

    /* =================================================================
       KNOB STYLES
       ================================================================= */
    .knob-wrap {
        text-align: center;
        padding: 6px;
        width: 54px;
    }

    .knob-label {
        color: var(--text-muted);
        font-size: 9px;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 4px;
        font-family: 'Share Tech Mono', monospace;
    }

    .knob-outer {
        width: 42px;
        height: 42px;
        margin: 0 auto 4px auto;
        background: var(--bg-void);
        border: 2px solid var(--border);
        border-radius: 50%;
        padding: 3px;
    }

    .knob-mid {
        width: 36px;
        height: 36px;
        background: var(--bg-knob);
        border: 1px solid var(--border);
        border-top-color: var(--border-light);
        border-left-color: var(--border-light);
        border-radius: 50%;
        position: relative;
        cursor: pointer;
        transition: box-shadow 0.2s;
    }

    .knob-mid:hover {
        box-shadow: 0 0 12px var(--glow);
    }

    .knob-inner {
        position: absolute;
        top: 6px;
        left: 6px;
        width: 22px;
        height: 22px;
        background: var(--bg-knob-inner);
        border: 1px solid var(--border);
        border-top-color: var(--border-light);
        border-left-color: var(--border-light);
        border-radius: 50%;
    }

    .knob-line {
        position: absolute;
        width: 2px;
        height: 8px;
        background: var(--accent);
        top: 3px;
        left: 17px;
        box-shadow: 0 0 6px var(--glow);
    }

    .knob-val {
        color: var(--accent);
        font-size: 10px;
        font-family: 'Share Tech Mono', Consolas, monospace;
    }

    /* =================================================================
       WAVE BUTTONS
       ================================================================= */
    .wave-btn {
        display: block;
        width: 100%;
        padding: 5px 10px;
        margin: 2px 0;
        background: var(--bg-control);
        border: 1px solid var(--border);
        border-top-color: var(--border-light);
        border-left-color: var(--border-light);
        color: var(--text-muted);
        font-size: 10px;
        cursor: pointer;
        text-align: left;
        font-family: 'Share Tech Mono', Tahoma, sans-serif;
        transition: all 0.15s;
    }

    .wave-btn:hover {
        border-color: var(--accent);
        color: var(--text);
    }

    .wave-btn-active {
        background: var(--accent);
        color: var(--bg-void);
        border-color: var(--accent);
        font-weight: bold;
        box-shadow: 0 0 10px var(--glow);
    }

    /* =================================================================
       THEME BUTTONS
       ================================================================= */
    .theme-btn {
        padding: 5px 12px;
        margin: 0 3px;
        border: 1px solid var(--border);
        border-top-color: var(--border-light);
        border-left-color: var(--border-light);
        background: var(--bg-control);
        color: var(--text-muted);
        font-size: 10px;
        cursor: pointer;
        font-family: 'Share Tech Mono', Tahoma, sans-serif;
        text-transform: uppercase;
        letter-spacing: 1px;
        transition: all 0.15s;
    }

    .theme-btn:hover {
        border-color: var(--accent);
        color: var(--text);
    }

    .theme-btn-active {
        background: var(--accent);
        color: var(--bg-void);
        border-color: var(--accent);
        font-weight: bold;
        box-shadow: 0 0 8px var(--glow);
    }

    /* =================================================================
       SELECT DROPDOWN
       ================================================================= */
    .select-wrap {
        position: relative;
        display: inline-block;
    }

    .styled-select {
        background: var(--bg-control);
        border: 1px solid var(--border);
        color: var(--text);
        padding: 6px 22px 6px 8px;
        font-size: 10px;
        width: 78px;
        font-family: 'Share Tech Mono', Tahoma, sans-serif;
        cursor: pointer;
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
    }

    .styled-select:hover {
        border-color: var(--accent);
    }

    .styled-select:focus {
        outline: none;
        border-color: var(--accent);
        box-shadow: 0 0 8px var(--glow);
    }

    .select-arrow {
        position: absolute;
        right: 8px;
        top: 50%;
        margin-top: -3px;
        width: 0;
        height: 0;
        border-left: 4px solid transparent;
        border-right: 4px solid transparent;
        border-top: 6px solid var(--accent);
        pointer-events: none;
    }

    /* =================================================================
       HEADER & FOOTER
       ================================================================= */
    .header {
        padding: 12px 16px;
        background: var(--bg-main);
        border-bottom: 2px solid var(--border);
    }

    .logo {
        font-size: 20px;
        font-weight: bold;
        letter-spacing: 3px;
        color: var(--accent);
        font-family: 'Share Tech Mono', monospace;
        text-shadow: 0 0 15px var(--glow);
    }

    .subtitle {
        font-size: 10px;
        letter-spacing: 1px;
        margin-top: 3px;
        color: var(--text-muted);
    }

    .footer {
        padding: 8px 16px;
        font-size: 9px;
        background: var(--bg-main);
        border-top: 1px solid var(--border);
    }

    .led {
        display: inline-block;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        margin-right: 8px;
        background: var(--accent);
        box-shadow: 0 0 8px var(--glow);
        animation: led-pulse 2s ease-in-out infinite;
    }

    @keyframes led-pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }

    .badge {
        display: inline-block;
        padding: 3px 8px;
        margin-left: 6px;
        background: var(--bg-control);
        border: 1px solid var(--border);
        font-size: 9px;
        color: var(--text-muted);
        font-family: 'Share Tech Mono', monospace;
    }

    /* =================================================================
       FX & SECTION LABELS
       ================================================================= */
    .fx-title {
        color: var(--accent2);
        font-size: 10px;
        font-weight: bold;
        margin-bottom: 8px;
        letter-spacing: 1px;
        font-family: 'Share Tech Mono', monospace;
        text-transform: uppercase;
    }

    .section-label {
        color: var(--accent3);
        font-size: 9px;
        font-weight: bold;
        margin-bottom: 6px;
        letter-spacing: 1px;
        font-family: 'Share Tech Mono', monospace;
        text-transform: uppercase;
    }

    /* =================================================================
       OSCILLOSCOPE - Modern Canvas Version
       ================================================================= */
    .scope-panel {
        display: flex;
        flex-direction: column;
    }

    .scope-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
    }

    .scope-title {
        color: var(--accent);
        font-size: 9px;
        font-weight: bold;
        letter-spacing: 1px;
        font-family: 'Share Tech Mono', monospace;
        text-transform: uppercase;
        text-shadow: 0 0 8px var(--glow);
    }

    .scope-controls {
        display: flex;
        gap: 8px;
    }

    .scope-btn {
        background: var(--bg-control);
        border: 1px solid var(--border);
        color: var(--text-muted);
        padding: 3px 8px;
        font-size: 8px;
        font-family: 'Share Tech Mono', monospace;
        cursor: pointer;
        border-radius: 2px;
        transition: all 0.15s;
    }

    .scope-btn:hover {
        border-color: var(--accent);
        color: var(--text);
    }

    .scope-btn.active {
        background: var(--accent);
        color: var(--bg-void);
        border-color: var(--accent);
    }

    .scope-container {
        background: var(--bg-void);
        border: 1px solid var(--border);
        border-radius: 4px;
        position: relative;
        overflow: hidden;
        height: 70px;
    }

    .scope-canvas {
        width: 100%;
        height: 100%;
        display: block;
    }

    .scope-overlay {
        position: absolute;
        inset: 0;
        pointer-events: none;
        background: 
            linear-gradient(90deg, var(--bg-void) 0%, transparent 2%, transparent 98%, var(--bg-void) 100%),
            linear-gradient(180deg, var(--bg-void) 0%, transparent 5%, transparent 95%, var(--bg-void) 100%);
    }

    .scope-info {
        position: absolute;
        bottom: 4px;
        right: 6px;
        font-size: 8px;
        color: var(--text-muted);
        font-family: 'Share Tech Mono', monospace;
        opacity: 0.6;
    }

    /* =================================================================
       MAIN CONTAINER
       ================================================================= */
    .synth-main {
        background: var(--bg-main);
        border: 2px solid var(--border);
        position: relative;
        z-index: 1;
    }

    /* =================================================================
       SMOOTH THEME TRANSITIONS
       ================================================================= */
    body, .synth-main, .panel, .knob-outer, .knob-mid, .knob-inner,
    .wave-btn, .theme-btn, .styled-select, .header, .footer, .led,
    .badge, .scope-container, .fx-title, .panel-title, .knob-val,
    .knob-line, .knob-label, .section-label {
        transition: background-color 0.4s ease, border-color 0.4s ease,
                    color 0.4s ease, box-shadow 0.4s ease, opacity 0.4s ease;
    }

    /* =================================================================
       GLASS MORPHISM PANELS
       ================================================================= */
    .panel {
        background: linear-gradient(135deg,
            rgba(255,255,255,0.03) 0%,
            rgba(255,255,255,0.01) 100%);
        backdrop-filter: blur(2px);
        -webkit-backdrop-filter: blur(2px);
    }
    .theme-heaven .panel {
        background: linear-gradient(135deg,
            rgba(255,255,255,0.5) 0%,
            rgba(255,255,255,0.3) 100%);
        backdrop-filter: blur(4px);
    }

    /* =================================================================
       KNOB TICK MARKS
       ================================================================= */
    .knob-outer {
        position: relative;
    }
    .knob-outer::before {
        content: '';
        position: absolute;
        inset: -4px;
        border-radius: 50%;
        background: conic-gradient(from 225deg,
            var(--accent) 0deg, var(--accent) 2deg, transparent 2deg, transparent 27deg,
            var(--border) 27deg, var(--border) 29deg, transparent 29deg, transparent 54deg,
            var(--border) 54deg, var(--border) 56deg, transparent 56deg, transparent 81deg,
            var(--border) 81deg, var(--border) 83deg, transparent 83deg, transparent 108deg,
            var(--border) 108deg, var(--border) 110deg, transparent 110deg, transparent 135deg,
            var(--border) 135deg, var(--border) 137deg, transparent 137deg, transparent 162deg,
            var(--border) 162deg, var(--border) 164deg, transparent 164deg, transparent 189deg,
            var(--border) 189deg, var(--border) 191deg, transparent 191deg, transparent 216deg,
            var(--border) 216deg, var(--border) 218deg, transparent 218deg, transparent 243deg,
            var(--border) 243deg, var(--border) 245deg, transparent 245deg, transparent 268deg,
            var(--accent) 268deg, var(--accent) 270deg, transparent 270deg
        );
        opacity: 0.5;
        pointer-events: none;
    }

    /* =================================================================
       LEVEL METERS
       ================================================================= */
    .level-meter-container {
        display: flex;
        gap: 4px;
        align-items: flex-end;
        height: 50px;
        padding: 4px;
    }
    .level-meter {
        width: 8px;
        height: 100%;
        background: var(--bg-void);
        border: 1px solid var(--border);
        border-radius: 2px;
        position: relative;
        overflow: hidden;
    }
    .level-meter-fill {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background: linear-gradient(to top,
            var(--accent) 0%,
            var(--accent) 60%,
            #ffcc00 80%,
            #ff4444 100%);
        transition: height 0.05s linear;
    }
    .level-meter-peak {
        position: absolute;
        left: 0;
        right: 0;
        height: 2px;
        background: var(--accent);
        box-shadow: 0 0 4px var(--glow);
    }
    .level-label {
        font-size: 8px;
        color: var(--text-muted);
        text-align: center;
        font-family: 'Share Tech Mono', monospace;
    }

    /* =================================================================
       EFFECT ACTIVE GLOW
       ================================================================= */
    .panel.fx-active {
        box-shadow: inset 0 0 20px var(--glow), 0 0 15px var(--glow);
    }
    .panel.fx-active .fx-title::after {
        content: ' ●';
        color: var(--accent);
        animation: fx-active-pulse 1s ease-in-out infinite;
    }
    @keyframes fx-active-pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }

    /* =================================================================
       MIDI ACTIVITY LED
       ================================================================= */
    .midi-led {
        display: inline-block;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: var(--bg-control);
        border: 1px solid var(--border);
        margin-right: 6px;
        transition: all 0.05s;
    }
    .midi-led.active {
        background: var(--accent);
        box-shadow: 0 0 8px var(--glow);
    }

    /* =================================================================
       VOICE COUNT
       ================================================================= */
    .voice-count {
        display: inline-block;
        padding: 2px 6px;
        background: var(--bg-control);
        border: 1px solid var(--border);
        border-radius: 3px;
        font-size: 9px;
        font-family: 'Share Tech Mono', monospace;
        color: var(--accent);
        margin-left: 8px;
    }

    /* =================================================================
       TOOLTIPS
       ================================================================= */
    .knob-wrap {
        position: relative;
    }
    .knob-wrap::after {
        content: attr(data-tooltip);
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        padding: 4px 8px;
        background: var(--bg-void);
        border: 1px solid var(--accent);
        color: var(--text);
        font-size: 9px;
        font-family: 'Share Tech Mono', monospace;
        white-space: nowrap;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.2s;
        z-index: 100;
        border-radius: 3px;
    }
    .knob-wrap:hover::after {
        opacity: 1;
    }
    .knob-wrap[data-tooltip=""]::after {
        display: none;
    }

    /* =================================================================
       PRESET BUTTONS
       ================================================================= */
    .preset-bar {
        display: flex;
        gap: 6px;
        align-items: center;
        margin-left: 16px;
    }
    .preset-btn {
        padding: 4px 10px;
        background: var(--bg-control);
        border: 1px solid var(--border);
        color: var(--text-muted);
        font-size: 9px;
        font-family: 'Share Tech Mono', monospace;
        cursor: pointer;
        transition: all 0.15s;
        text-transform: uppercase;
        letter-spacing: 1px;
    }
    .preset-btn:hover {
        border-color: var(--accent);
        color: var(--text);
        box-shadow: 0 0 8px var(--glow);
    }
    .preset-btn:active {
        background: var(--accent);
        color: var(--bg-void);
    }
    .preset-name {
        padding: 4px 12px;
        background: var(--bg-void);
        border: 1px solid var(--border);
        color: var(--accent);
        font-size: 10px;
        font-family: 'Share Tech Mono', monospace;
        min-width: 120px;
        text-align: center;
    }

    /* =================================================================
       SPECTRUM FREQUENCY LABELS
       ================================================================= */
    .freq-labels {
        display: flex;
        justify-content: space-between;
        padding: 2px 4px 0 4px;
        font-size: 7px;
        color: var(--text-muted);
        font-family: 'Share Tech Mono', monospace;
        opacity: 0.6;
    }

    /* =================================================================
       ENHANCED PANEL DEPTH
       ================================================================= */
    .panel {
        box-shadow:
            inset 1px 1px 0 rgba(255,255,255,0.05),
            inset -1px -1px 0 rgba(0,0,0,0.2),
            0 4px 12px rgba(0,0,0,0.3);
    }
    .panel:hover {
        box-shadow:
            inset 1px 1px 0 rgba(255,255,255,0.08),
            inset -1px -1px 0 rgba(0,0,0,0.2),
            0 6px 16px rgba(0,0,0,0.4);
    }

    /* =================================================================
       LOGO HOVER EFFECT
       ================================================================= */
    .logo {
        cursor: default;
        transition: all 0.3s ease;
    }
    .logo:hover {
        letter-spacing: 5px;
        text-shadow: 0 0 20px var(--glow), 0 0 40px var(--glow);
    }

    /* =================================================================
       BUTTON MICRO-INTERACTIONS
       ================================================================= */
    .wave-btn {
        transform: translateY(0);
        transition: all 0.1s ease;
    }
    .wave-btn:hover {
        transform: translateY(-1px);
    }
    .wave-btn:active {
        transform: translateY(1px);
    }
    .wave-btn-active {
        transform: translateY(0);
    }

    .theme-btn {
        transform: scale(1);
        transition: all 0.15s ease;
    }
    .theme-btn:hover {
        transform: scale(1.05);
    }
    .theme-btn:active {
        transform: scale(0.95);
    }

    /* =================================================================
       KNOB ACTIVE STATE
       ================================================================= */
    .knob-mid.dragging {
        box-shadow: 0 0 20px var(--glow), inset 0 0 10px rgba(0,0,0,0.3);
        transform: scale(1.05);
    }
    .knob-mid {
        transform: scale(1);
        transition: transform 0.1s ease, box-shadow 0.2s ease;
    }

    /* =================================================================
       OSCILLOSCOPE GLOW BORDER
       ================================================================= */
    .scope-container {
        box-shadow: inset 0 0 20px rgba(0,0,0,0.5), 0 0 1px var(--accent);
        transition: box-shadow 0.3s ease;
    }
    .scope-container:hover {
        box-shadow: inset 0 0 20px rgba(0,0,0,0.5), 0 0 8px var(--glow);
    }

    /* =================================================================
       FOOTER STATUS GLOW
       ================================================================= */
    .footer {
        position: relative;
        overflow: hidden;
    }
    .footer::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 1px;
        background: linear-gradient(90deg, transparent, var(--accent), transparent);
        opacity: 0.5;
    }

    /* =================================================================
       HEADER GRADIENT
       ================================================================= */
    .header {
        background: linear-gradient(180deg, var(--bg-main) 0%, var(--bg-panel) 100%);
    }

    /* =================================================================
       SELECT FOCUS RING
       ================================================================= */
    .styled-select:focus {
        outline: none;
        border-color: var(--accent);
        box-shadow: 0 0 0 2px var(--glow);
    }

    /* =================================================================
       BADGE HOVER
       ================================================================= */
    .badge {
        transition: all 0.2s ease;
        cursor: default;
    }
    .badge:hover {
        background: var(--accent);
        color: var(--bg-void);
        border-color: var(--accent);
    }
</style>

</head>
<body id="body">
    <table width="920" cellpadding="0" cellspacing="0" align="center" class="synth-main" id="synth">
        <!-- Header -->
        <tr>
            <td colspan="4" class="header">
                <table width="100%" cellpadding="0" cellspacing="0">
                    <tr>
                        <td>
                            <span class="logo" id="logo">SCHOFFHAUZER</span>
                            <span style="color: var(--text-muted); font-size: 16px; font-weight: normal;"> FM</span>
                            <div class="subtitle">Quasi-Bandlimited FM Synthesizer · 8 Voices</div>
                        </td>
                        <td align="center" valign="middle">
                            <div class="preset-bar">
                                <button class="preset-btn" onclick="initPatch()" title="Initialize patch">Init</button>
                                <div class="preset-name" id="preset-name">Default</div>
                                <button class="preset-btn" onclick="randomizePatch()" title="Randomize parameters">Rnd</button>
                            </div>
                        </td>
                        <td align="right" valign="middle">
                            <button class="theme-btn theme-btn-active" id="theme-celestial" onclick="setTheme('celestial')">Celestial</button>
                            <button class="theme-btn" id="theme-heaven" onclick="setTheme('heaven')">Heaven</button>
                            <button class="theme-btn" id="theme-hell" onclick="setTheme('hell')">Hell</button>
                            <button class="theme-btn" id="theme-death" onclick="setTheme('death')">Death</button>
                        </td>
                    </tr>
                </table>
            </td>
        </tr>

    <!-- OSC 1 & OSC 2 -->
    <tr>
        <td width="50%" valign="top">
            <div class="panel">
                <div class="panel-title">Oscillator 1</div>
                <table cellpadding="0" cellspacing="0">
                    <tr>
                        <td valign="top" style="padding-right: 12px;">
                            <div id="osc1-waves">
                                <button class="wave-btn wave-btn-active" onclick="setWave('osc1_wave', 0, this)">▶ Saw</button>
                                <button class="wave-btn" onclick="setWave('osc1_wave', 1, this)">▶ Saw+</button>
                                <button class="wave-btn" onclick="setWave('osc1_wave', 2, this)">▲ Tri</button>
                                <button class="wave-btn" onclick="setWave('osc1_wave', 3, this)">▲ Tri+</button>
                                <button class="wave-btn" onclick="setWave('osc1_wave', 4, this)">■ Sqr</button>
                                <button class="wave-btn" onclick="setWave('osc1_wave', 5, this)">▬ Pulse</button>
                                <button class="wave-btn" onclick="setWave('osc1_wave', 6, this)">● Sine</button>
                            </div>
                        </td>
                        <td>
                            <table cellpadding="0" cellspacing="0">
                                <tr>
                                    <td class="knob-wrap"><div class="knob-label">Oct</div><div class="knob-outer"><div class="knob-mid" id="knob-osc1_octave" data-p="osc1_octave" data-min="-3" data-max="3" data-val="0" data-step="1"><div class="knob-inner"></div><div class="knob-line" id="line-osc1_octave"></div></div></div><div class="knob-val" id="val-osc1_octave">0</div></td>
                                    <td class="knob-wrap"><div class="knob-label">Semi</div><div class="knob-outer"><div class="knob-mid" id="knob-osc1_semi" data-p="osc1_semi" data-min="-12" data-max="12" data-val="0" data-step="1"><div class="knob-inner"></div><div class="knob-line" id="line-osc1_semi"></div></div></div><div class="knob-val" id="val-osc1_semi">0</div></td>
                                    <td class="knob-wrap"><div class="knob-label">Fine</div><div class="knob-outer"><div class="knob-mid" id="knob-osc1_fine" data-p="osc1_fine" data-min="-100" data-max="100" data-val="0" data-step="1"><div class="knob-inner"></div><div class="knob-line" id="line-osc1_fine"></div></div></div><div class="knob-val" id="val-osc1_fine">0</div></td>
                                    <td class="knob-wrap"><div class="knob-label">PW</div><div class="knob-outer"><div class="knob-mid" id="knob-osc1_pw" data-p="osc1_pw" data-min="0.05" data-max="0.95" data-val="0.5" data-step="0.01"><div class="knob-inner"></div><div class="knob-line" id="line-osc1_pw"></div></div></div><div class="knob-val" id="val-osc1_pw">50%</div></td>
                                </tr>
                                <tr>
                                    <td class="knob-wrap"><div class="knob-label">Level</div><div class="knob-outer"><div class="knob-mid" id="knob-osc1_gain" data-p="osc1_gain" data-min="0" data-max="1" data-val="0.7" data-step="0.01"><div class="knob-inner"></div><div class="knob-line" id="line-osc1_gain"></div></div></div><div class="knob-val" id="val-osc1_gain">70%</div></td>
                                    <td class="knob-wrap"><div class="knob-label">Pan</div><div class="knob-outer"><div class="knob-mid" id="knob-osc1_pan" data-p="osc1_pan" data-min="-1" data-max="1" data-val="0" data-step="0.01"><div class="knob-inner"></div><div class="knob-line" id="line-osc1_pan"></div></div></div><div class="knob-val" id="val-osc1_pan">C</div></td>
                                    <td></td>
                                    <td></td>
                                </tr>
                            </table>
                        </td>
                    </tr>
                </table>
            </div>
        </td>
        <td width="50%" valign="top">
            <div class="panel">
                <div class="panel-title">Oscillator 2</div>
                <table cellpadding="0" cellspacing="0">
                    <tr>
                        <td valign="top" style="padding-right: 12px;">
                            <div id="osc2-waves">
                                <button class="wave-btn wave-btn-active" onclick="setWave('osc2_wave', 0, this)">▶ Saw</button>
                                <button class="wave-btn" onclick="setWave('osc2_wave', 1, this)">▶ Saw+</button>
                                <button class="wave-btn" onclick="setWave('osc2_wave', 2, this)">▲ Tri</button>
                                <button class="wave-btn" onclick="setWave('osc2_wave', 3, this)">▲ Tri+</button>
                                <button class="wave-btn" onclick="setWave('osc2_wave', 4, this)">■ Sqr</button>
                                <button class="wave-btn" onclick="setWave('osc2_wave', 5, this)">▬ Pulse</button>
                                <button class="wave-btn" onclick="setWave('osc2_wave', 6, this)">● Sine</button>
                            </div>
                        </td>
                        <td>
                            <table cellpadding="0" cellspacing="0">
                                <tr>
                                    <td class="knob-wrap"><div class="knob-label">Oct</div><div class="knob-outer"><div class="knob-mid" id="knob-osc2_octave" data-p="osc2_octave" data-min="-3" data-max="3" data-val="0" data-step="1"><div class="knob-inner"></div><div class="knob-line" id="line-osc2_octave"></div></div></div><div class="knob-val" id="val-osc2_octave">0</div></td>
                                    <td class="knob-wrap"><div class="knob-label">Semi</div><div class="knob-outer"><div class="knob-mid" id="knob-osc2_semi" data-p="osc2_semi" data-min="-12" data-max="12" data-val="0" data-step="1"><div class="knob-inner"></div><div class="knob-line" id="line-osc2_semi"></div></div></div><div class="knob-val" id="val-osc2_semi">0</div></td>
                                    <td class="knob-wrap"><div class="knob-label">Fine</div><div class="knob-outer"><div class="knob-mid" id="knob-osc2_fine" data-p="osc2_fine" data-min="-100" data-max="100" data-val="0" data-step="1"><div class="knob-inner"></div><div class="knob-line" id="line-osc2_fine"></div></div></div><div class="knob-val" id="val-osc2_fine">0</div></td>
                                    <td class="knob-wrap"><div class="knob-label">PW</div><div class="knob-outer"><div class="knob-mid" id="knob-osc2_pw" data-p="osc2_pw" data-min="0.05" data-max="0.95" data-val="0.5" data-step="0.01"><div class="knob-inner"></div><div class="knob-line" id="line-osc2_pw"></div></div></div><div class="knob-val" id="val-osc2_pw">50%</div></td>
                                </tr>
                                <tr>
                                    <td class="knob-wrap"><div class="knob-label">Level</div><div class="knob-outer"><div class="knob-mid" id="knob-osc2_gain" data-p="osc2_gain" data-min="0" data-max="1" data-val="0.7" data-step="0.01"><div class="knob-inner"></div><div class="knob-line" id="line-osc2_gain"></div></div></div><div class="knob-val" id="val-osc2_gain">70%</div></td>
                                    <td class="knob-wrap"><div class="knob-label">Pan</div><div class="knob-outer"><div class="knob-mid" id="knob-osc2_pan" data-p="osc2_pan" data-min="-1" data-max="1" data-val="0" data-step="0.01"><div class="knob-inner"></div><div class="knob-line" id="line-osc2_pan"></div></div></div><div class="knob-val" id="val-osc2_pan">C</div></td>
                                    <td></td>
                                    <td></td>
                                </tr>
                            </table>
                        </td>
                    </tr>
                </table>
            </div>
        </td>
    </tr>

    <!-- SUB/NOISE & FILTER -->
    <tr>
        <td valign="top">
            <div class="panel">
                <div class="panel-title">Sub / Noise</div>
                <table cellpadding="0" cellspacing="0">
                    <tr>
                        <td valign="top" style="padding-right: 16px;">
                            <div class="section-label">SUB</div>
                            <table cellpadding="0" cellspacing="0">
                                <tr>
                                    <td style="padding-right: 10px;">
                                        <div style="font-size: 9px; color: var(--text-muted); margin-bottom: 3px;">Wave</div>
                                        <div class="select-wrap">
                                            <select class="styled-select" id="sub_wave" onchange="sendParam('sub_wave', this.value)">
                                                <option value="0">Sine</option>
                                                <option value="1">Square</option>
                                                <option value="2">Saw</option>
                                                <option value="3">Tri</option>
                                            </select>
                                            <div class="select-arrow"></div>
                                        </div>
                                    </td>
                                    <td style="padding-right: 10px;">
                                        <div style="font-size: 9px; color: var(--text-muted); margin-bottom: 3px;">Oct</div>
                                        <div class="select-wrap">
                                            <select class="styled-select" style="width: 56px;" id="sub_octave" onchange="sendParam('sub_octave', this.value)">
                                                <option value="0">-2</option>
                                                <option value="1" selected>-1</option>
                                            </select>
                                            <div class="select-arrow"></div>
                                        </div>
                                    </td>
                                    <td class="knob-wrap"><div class="knob-label">Level</div><div class="knob-outer"><div class="knob-mid" id="knob-sub_level" data-p="sub_level" data-min="0" data-max="1" data-val="0" data-step="0.01"><div class="knob-inner"></div><div class="knob-line" id="line-sub_level"></div></div></div><div class="knob-val" id="val-sub_level">0%</div></td>
                                </tr>
                            </table>
                        </td>
                        <td valign="top" style="border-left: 1px solid var(--border); padding-left: 16px;">
                            <div class="section-label" style="color: var(--accent2);">NOISE</div>
                            <table cellpadding="0" cellspacing="0">
                                <tr>
                                    <td style="padding-right: 10px;">
                                        <div style="font-size: 9px; color: var(--text-muted); margin-bottom: 3px;">Type</div>
                                        <div class="select-wrap">
                                            <select class="styled-select" id="noise_type" onchange="sendParam('noise_type', this.value)">
                                                <option value="0">White</option>
                                                <option value="1">Pink</option>
                                                <option value="2">Brown</option>
                                            </select>
                                            <div class="select-arrow"></div>
                                        </div>
                                    </td>
                                    <td class="knob-wrap"><div class="knob-label">Level</div><div class="knob-outer"><div class="knob-mid" id="knob-noise_level" data-p="noise_level" data-min="0" data-max="0.5" data-val="0" data-step="0.01"><div class="knob-inner"></div><div class="knob-line" id="line-noise_level"></div></div></div><div class="knob-val" id="val-noise_level">0%</div></td>
                                </tr>
                            </table>
                        </td>
                    </tr>
                </table>
            </div>
        </td>
        <td valign="top">
            <div class="panel">
                <div class="panel-title">Filter</div>
                <table cellpadding="0" cellspacing="0">
                    <tr>
                        <td class="knob-wrap"><div class="knob-label">Cutoff</div><div class="knob-outer"><div class="knob-mid" id="knob-filter_cutoff" data-p="filter_cutoff" data-min="20" data-max="20000" data-val="8000" data-step="1" data-log="1"><div class="knob-inner"></div><div class="knob-line" id="line-filter_cutoff"></div></div></div><div class="knob-val" id="val-filter_cutoff">8.0k</div></td>
                        <td class="knob-wrap"><div class="knob-label">Reso</div><div class="knob-outer"><div class="knob-mid" id="knob-filter_reso" data-p="filter_reso" data-min="0.5" data-max="10" data-val="1" data-step="0.1"><div class="knob-inner"></div><div class="knob-line" id="line-filter_reso"></div></div></div><div class="knob-val" id="val-filter_reso">1.0</div></td>
                        <td class="knob-wrap"><div class="knob-label">Env</div><div class="knob-outer"><div class="knob-mid" id="knob-filter_env" data-p="filter_env" data-min="-1" data-max="1" data-val="0.3" data-step="0.01"><div class="knob-inner"></div><div class="knob-line" id="line-filter_env"></div></div></div><div class="knob-val" id="val-filter_env">30%</div></td>
                        <td class="knob-wrap"><div class="knob-label">Key</div><div class="knob-outer"><div class="knob-mid" id="knob-filter_key" data-p="filter_key" data-min="0" data-max="1" data-val="0" data-step="0.01"><div class="knob-inner"></div><div class="knob-line" id="line-filter_key"></div></div></div><div class="knob-val" id="val-filter_key">0%</div></td>
                        <td class="knob-wrap"><div class="knob-label">Drive</div><div class="knob-outer"><div class="knob-mid" id="knob-filter_drive" data-p="filter_drive" data-min="1" data-max="4" data-val="1" data-step="0.1"><div class="knob-inner"></div><div class="knob-line" id="line-filter_drive"></div></div></div><div class="knob-val" id="val-filter_drive">1.0</div></td>
                    </tr>
                </table>
            </div>
        </td>
    </tr>

    <!-- ENVELOPES -->
    <tr>
        <td valign="top">
            <div class="panel">
                <div class="panel-title">Amp Envelope</div>
                <table cellpadding="0" cellspacing="0">
                    <tr>
                        <td class="knob-wrap"><div class="knob-label">Attack</div><div class="knob-outer"><div class="knob-mid" id="knob-amp_a" data-p="amp_a" data-min="0.001" data-max="4" data-val="0.01" data-step="0.001" data-log="1"><div class="knob-inner"></div><div class="knob-line" id="line-amp_a"></div></div></div><div class="knob-val" id="val-amp_a">10ms</div></td>
                        <td class="knob-wrap"><div class="knob-label">Decay</div><div class="knob-outer"><div class="knob-mid" id="knob-amp_d" data-p="amp_d" data-min="0.001" data-max="4" data-val="0.2" data-step="0.001" data-log="1"><div class="knob-inner"></div><div class="knob-line" id="line-amp_d"></div></div></div><div class="knob-val" id="val-amp_d">200ms</div></td>
                        <td class="knob-wrap"><div class="knob-label">Sustain</div><div class="knob-outer"><div class="knob-mid" id="knob-amp_s" data-p="amp_s" data-min="0" data-max="1" data-val="0.7" data-step="0.01"><div class="knob-inner"></div><div class="knob-line" id="line-amp_s"></div></div></div><div class="knob-val" id="val-amp_s">70%</div></td>
                        <td class="knob-wrap"><div class="knob-label">Release</div><div class="knob-outer"><div class="knob-mid" id="knob-amp_r" data-p="amp_r" data-min="0.001" data-max="8" data-val="0.3" data-step="0.001" data-log="1"><div class="knob-inner"></div><div class="knob-line" id="line-amp_r"></div></div></div><div class="knob-val" id="val-amp_r">300ms</div></td>
                    </tr>
                </table>
            </div>
        </td>
        <td valign="top">
            <div class="panel">
                <div class="panel-title">Filter Envelope</div>
                <table cellpadding="0" cellspacing="0">
                    <tr>
                        <td class="knob-wrap"><div class="knob-label">Attack</div><div class="knob-outer"><div class="knob-mid" id="knob-flt_a" data-p="flt_a" data-min="0.001" data-max="4" data-val="0.01" data-step="0.001" data-log="1"><div class="knob-inner"></div><div class="knob-line" id="line-flt_a"></div></div></div><div class="knob-val" id="val-flt_a">10ms</div></td>
                        <td class="knob-wrap"><div class="knob-label">Decay</div><div class="knob-outer"><div class="knob-mid" id="knob-flt_d" data-p="flt_d" data-min="0.001" data-max="4" data-val="0.3" data-step="0.001" data-log="1"><div class="knob-inner"></div><div class="knob-line" id="line-flt_d"></div></div></div><div class="knob-val" id="val-flt_d">300ms</div></td>
                        <td class="knob-wrap"><div class="knob-label">Sustain</div><div class="knob-outer"><div class="knob-mid" id="knob-flt_s" data-p="flt_s" data-min="0" data-max="1" data-val="0.3" data-step="0.01"><div class="knob-inner"></div><div class="knob-line" id="line-flt_s"></div></div></div><div class="knob-val" id="val-flt_s">30%</div></td>
                        <td class="knob-wrap"><div class="knob-label">Release</div><div class="knob-outer"><div class="knob-mid" id="knob-flt_r" data-p="flt_r" data-min="0.001" data-max="8" data-val="0.5" data-step="0.001" data-log="1"><div class="knob-inner"></div><div class="knob-line" id="line-flt_r"></div></div></div><div class="knob-val" id="val-flt_r">500ms</div></td>
                    </tr>
                </table>
            </div>
        </td>
    </tr>

    <!-- EFFECTS -->
    <tr>
        <td colspan="2">
            <table width="100%" cellpadding="0" cellspacing="0">
                <tr>
                    <td width="25%" valign="top">
                        <div class="panel">
                            <div class="fx-title">Exciter</div>
                            <table cellpadding="0" cellspacing="0"><tr>
                                <td class="knob-wrap"><div class="knob-label">Freq</div><div class="knob-outer"><div class="knob-mid" id="knob-exciter_freq" data-p="exciter_freq" data-min="500" data-max="12000" data-val="3000" data-step="1" data-log="1"><div class="knob-inner"></div><div class="knob-line" id="line-exciter_freq"></div></div></div><div class="knob-val" id="val-exciter_freq">3.0k</div></td>
                                <td class="knob-wrap"><div class="knob-label">Drive</div><div class="knob-outer"><div class="knob-mid" id="knob-exciter_drive" data-p="exciter_drive" data-min="0" data-max="1" data-val="0.5" data-step="0.01"><div class="knob-inner"></div><div class="knob-line" id="line-exciter_drive"></div></div></div><div class="knob-val" id="val-exciter_drive">50%</div></td>
                                <td class="knob-wrap"><div class="knob-label">Mix</div><div class="knob-outer"><div class="knob-mid" id="knob-exciter_mix" data-p="exciter_mix" data-min="0" data-max="1" data-val="0" data-step="0.01"><div class="knob-inner"></div><div class="knob-line" id="line-exciter_mix"></div></div></div><div class="knob-val" id="val-exciter_mix">0%</div></td>
                            </tr></table>
                        </div>
                    </td>
                    <td width="25%" valign="top">
                        <div class="panel">
                            <div class="fx-title">Chorus</div>
                            <table cellpadding="0" cellspacing="0"><tr>
                                <td class="knob-wrap"><div class="knob-label">Rate</div><div class="knob-outer"><div class="knob-mid" id="knob-chorus_rate" data-p="chorus_rate" data-min="0.1" data-max="4" data-val="0.8" data-step="0.01"><div class="knob-inner"></div><div class="knob-line" id="line-chorus_rate"></div></div></div><div class="knob-val" id="val-chorus_rate">0.80</div></td>
                                <td class="knob-wrap"><div class="knob-label">Depth</div><div class="knob-outer"><div class="knob-mid" id="knob-chorus_depth" data-p="chorus_depth" data-min="0" data-max="1" data-val="0.5" data-step="0.01"><div class="knob-inner"></div><div class="knob-line" id="line-chorus_depth"></div></div></div><div class="knob-val" id="val-chorus_depth">50%</div></td>
                                <td class="knob-wrap"><div class="knob-label">Wet</div><div class="knob-outer"><div class="knob-mid" id="knob-chorus_wet" data-p="chorus_wet" data-min="0" data-max="1" data-val="0" data-step="0.01"><div class="knob-inner"></div><div class="knob-line" id="line-chorus_wet"></div></div></div><div class="knob-val" id="val-chorus_wet">0%</div></td>
                            </tr></table>
                        </div>
                    </td>
                    <td width="25%" valign="top">
                        <div class="panel">
                            <div class="fx-title">Delay</div>
                            <table cellpadding="0" cellspacing="0"><tr>
                                <td class="knob-wrap"><div class="knob-label">Time</div><div class="knob-outer"><div class="knob-mid" id="knob-delay_time" data-p="delay_time" data-min="0.01" data-max="1" data-val="0.375" data-step="0.001"><div class="knob-inner"></div><div class="knob-line" id="line-delay_time"></div></div></div><div class="knob-val" id="val-delay_time">375ms</div></td>
                                <td class="knob-wrap"><div class="knob-label">Fdbk</div><div class="knob-outer"><div class="knob-mid" id="knob-delay_fdbk" data-p="delay_fdbk" data-min="0" data-max="0.85" data-val="0.4" data-step="0.01"><div class="knob-inner"></div><div class="knob-line" id="line-delay_fdbk"></div></div></div><div class="knob-val" id="val-delay_fdbk">40%</div></td>
                                <td class="knob-wrap"><div class="knob-label">Wet</div><div class="knob-outer"><div class="knob-mid" id="knob-delay_wet" data-p="delay_wet" data-min="0" data-max="1" data-val="0" data-step="0.01"><div class="knob-inner"></div><div class="knob-line" id="line-delay_wet"></div></div></div><div class="knob-val" id="val-delay_wet">0%</div></td>
                            </tr></table>
                        </div>
                    </td>
                    <td width="25%" valign="top">
                        <div class="panel">
                            <div class="fx-title">Reverb</div>
                            <table cellpadding="0" cellspacing="0"><tr>
                                <td style="padding-right: 6px; vertical-align: top;">
                                    <div style="font-size: 9px; color: var(--text-muted); margin-bottom: 3px;">Type</div>
                                    <div class="select-wrap">
                                        <select class="styled-select" style="width: 72px;" id="reverb_type" onchange="sendParam('reverb_type', this.value)">
                                            <option value="0">Freeverb</option>
                                            <option value="1">Zita</option>
                                            <option value="2">Dattorro</option>
                                            <option value="3">JPverb</option>
                                            <option value="4">Greyhole</option>
                                        </select>
                                        <div class="select-arrow"></div>
                                    </div>
                                </td>
                                <td class="knob-wrap"><div class="knob-label">Size</div><div class="knob-outer"><div class="knob-mid" id="knob-reverb_size" data-p="reverb_size" data-min="0.1" data-max="0.95" data-val="0.6" data-step="0.01"><div class="knob-inner"></div><div class="knob-line" id="line-reverb_size"></div></div></div><div class="knob-val" id="val-reverb_size">60%</div></td>
                                <td class="knob-wrap"><div class="knob-label">Wet</div><div class="knob-outer"><div class="knob-mid" id="knob-reverb_wet" data-p="reverb_wet" data-min="0" data-max="1" data-val="0" data-step="0.01"><div class="knob-inner"></div><div class="knob-line" id="line-reverb_wet"></div></div></div><div class="knob-val" id="val-reverb_wet">0%</div></td>
                            </tr></table>
                        </div>
                    </td>
                </tr>
            </table>
        </td>
    </tr>

    <!-- OSCILLOSCOPE & MASTER -->
    <tr>
        <td colspan="2">
            <table width="100%" cellpadding="0" cellspacing="0">
                <tr>
                    <td width="70%" valign="top">
                        <div class="panel">
                            <div class="scope-panel">
                                <div class="scope-header">
                                    <div class="scope-title">Oscilloscope</div>
                                    <div class="scope-controls">
                                        <button class="scope-btn active" onclick="setScopeMode('wave')">Wave</button>
                                        <button class="scope-btn" onclick="setScopeMode('spectrum')">FFT</button>
                                    </div>
                                </div>
                                <div class="scope-container">
                                    <canvas class="scope-canvas" id="scope-canvas"></canvas>
                                    <div class="scope-overlay"></div>
                                    <div class="scope-info" id="scope-info">48kHz</div>
                                </div>
                                <div class="freq-labels" id="freq-labels" style="display: none;">
                                    <span>20</span><span>50</span><span>100</span><span>200</span><span>500</span><span>1k</span><span>2k</span><span>5k</span><span>10k</span><span>20k</span>
                                </div>
                            </div>
                        </div>
                    </td>
                    <td width="30%" valign="top">
                        <div class="panel">
                            <div class="panel-title">Master</div>
                            <table cellpadding="0" cellspacing="0"><tr>
                                <td class="knob-wrap" data-tooltip="Stereo width (Hilbert)"><div class="knob-label">Width</div><div class="knob-outer"><div class="knob-mid" id="knob-master_width" data-p="master_width" data-min="0" data-max="1" data-val="1" data-step="0.01"><div class="knob-inner"></div><div class="knob-line" id="line-master_width"></div></div></div><div class="knob-val" id="val-master_width">100%</div></td>
                                <td class="knob-wrap" data-tooltip="Output level"><div class="knob-label">Gain</div><div class="knob-outer"><div class="knob-mid" id="knob-master_gain" data-p="master_gain" data-min="-60" data-max="0" data-val="-12" data-step="0.1"><div class="knob-inner"></div><div class="knob-line" id="line-master_gain"></div></div></div><div class="knob-val" id="val-master_gain">-12dB</div></td>
                                <td style="padding-left: 8px; vertical-align: top;">
                                    <div style="font-size: 9px; color: var(--text-muted); margin-bottom: 3px; text-transform: uppercase; letter-spacing: 1px; font-family: 'Share Tech Mono', monospace;">Oversample</div>
                                    <div class="select-wrap">
                                        <select class="styled-select" style="width: 60px;" id="oversampling" onchange="sendParam('oversampling', this.value)">
                                            <option value="0" selected>Off</option>
                                            <option value="1">x4</option>
                                            <option value="2">x8</option>
                                        </select>
                                        <div class="select-arrow"></div>
                                    </div>
                                </td>
                                <td style="padding-left: 12px; vertical-align: top;">
                                    <div style="font-size: 9px; color: var(--text-muted); margin-bottom: 3px; text-transform: uppercase; letter-spacing: 1px; font-family: 'Share Tech Mono', monospace;">Level</div>
                                    <div class="level-meter-container">
                                        <div>
                                            <div class="level-meter">
                                                <div class="level-meter-fill" id="meter-l" style="height: 0%;"></div>
                                                <div class="level-meter-peak" id="peak-l" style="bottom: 0%;"></div>
                                            </div>
                                            <div class="level-label">L</div>
                                        </div>
                                        <div>
                                            <div class="level-meter">
                                                <div class="level-meter-fill" id="meter-r" style="height: 0%;"></div>
                                                <div class="level-meter-peak" id="peak-r" style="bottom: 0%;"></div>
                                            </div>
                                            <div class="level-label">R</div>
                                        </div>
                                    </div>
                                </td>
                            </tr></table>
                        </div>
                    </td>
                </tr>
            </table>
        </td>
    </tr>

    <!-- Footer -->
    <tr>
        <td colspan="2" class="footer">
            <table width="100%" cellpadding="0" cellspacing="0">
                <tr>
                    <td>
                        <span class="led" id="led"></span>
                        <span class="midi-led" id="midi-led" title="MIDI Activity"></span>
                        <span id="status-text">Ready</span>
                        <span class="voice-count" id="voice-count" title="Active voices">0/8</span>
                    </td>
                    <td align="right">
                        <span class="badge">Faust DSP</span>
                        <span class="badge">JUCE 8</span>
                        <span class="badge">WebView2</span>
                    </td>
                </tr>
            </table>
        </td>
    </tr>
</table>

<script>
var currentTheme = 'celestial';
var params = {};
var dragging = null;
var dragStartY = 0;
var dragStartVal = 0;

// Peak hold for level meters
var peakL = 0, peakR = 0;
var peakDecay = 0.995;
var peakHoldTime = 60; // frames
var peakHoldL = 0, peakHoldR = 0;

// Spectrum peak hold
var spectrumPeaks = new Array(256).fill(0);
var spectrumPeakDecay = 0.98;

// Default parameter values for init
var defaultParams = {
    osc1_wave: 0, osc1_octave: 0, osc1_semi: 0, osc1_fine: 0, osc1_pw: 0.5, osc1_gain: 0.7, osc1_pan: 0,
    osc2_wave: 0, osc2_octave: 0, osc2_semi: 0, osc2_fine: 0, osc2_pw: 0.5, osc2_gain: 0.7, osc2_pan: 0,
    sub_wave: 0, sub_octave: 1, sub_level: 0,
    noise_type: 0, noise_level: 0,
    filter_cutoff: 8000, filter_reso: 1, filter_env: 0.3, filter_key: 0, filter_drive: 1,
    amp_a: 0.01, amp_d: 0.2, amp_s: 0.7, amp_r: 0.3,
    flt_a: 0.01, flt_d: 0.3, flt_s: 0.3, flt_r: 0.5,
    exciter_freq: 3000, exciter_drive: 0.5, exciter_mix: 0,
    chorus_rate: 0.8, chorus_depth: 0.5, chorus_wet: 0,
    delay_time: 0.375, delay_fdbk: 0.4, delay_wet: 0,
    reverb_type: 0, reverb_size: 0.6, reverb_wet: 0,
    master_width: 1, master_gain: -12, oversampling: 0
};

function setTheme(name) {
    currentTheme = name;
    var container = document.getElementById('synth');
    var body = document.getElementById('body');
    
    // Remove all theme classes
    body.className = '';
    container.className = 'synth-main';
    
    if (name !== 'celestial') {
        body.classList.add('theme-' + name);
        container.classList.add('theme-' + name);
    }
    
    // Update theme buttons
    var themes = ['celestial', 'heaven', 'hell', 'death'];
    for (var i = 0; i < themes.length; i++) {
        var btn = document.getElementById('theme-' + themes[i]);
        if (btn) {
            if (themes[i] === name) {
                btn.className = 'theme-btn theme-btn-active';
            } else {
                btn.className = 'theme-btn';
            }
        }
    }
}

function sendParam(name, value) {
    params[name] = value;
    // JUCE 8 WebView2 API
    if (typeof __JUCE__ !== 'undefined' && __JUCE__.backend) {
        __JUCE__.backend.getNativeFunction('setParameter')(name, value);
    }
    console.log('[Param] ' + name + ' = ' + value);
}

function setWave(param, value, btn) {
    var parent = btn.parentNode;
    var btns = parent.getElementsByTagName('button');
    for (var i = 0; i < btns.length; i++) {
        btns[i].className = 'wave-btn';
    }
    btn.className = 'wave-btn wave-btn-active';
    sendParam(param, value);
}

function formatValue(param, value) {
    if (param.indexOf('cutoff') !== -1 || param.indexOf('freq') !== -1) {
        if (value >= 1000) return (value / 1000).toFixed(1) + 'k';
        return Math.round(value);
    }
    if (param.indexOf('_a') !== -1 || param.indexOf('_d') !== -1 || param.indexOf('_r') !== -1) {
        if (value >= 1) return value.toFixed(1) + 's';
        return Math.round(value * 1000) + 'ms';
    }
    if (param === 'master_gain') return value.toFixed(0) + 'dB';
    if (param.indexOf('pan') !== -1) {
        if (value === 0) return 'C';
        if (value < 0) return 'L' + Math.abs(Math.round(value * 100));
        return 'R' + Math.round(value * 100);
    }
    if (param.indexOf('reso') !== -1 || param.indexOf('drive') !== -1) return value.toFixed(1);
    if (param === 'delay_time') return Math.round(value * 1000) + 'ms';
    if (param.indexOf('rate') !== -1) return value.toFixed(2);
    if (param.indexOf('octave') !== -1 || param.indexOf('semi') !== -1 || param.indexOf('fine') !== -1) {
        if (value > 0) return '+' + Math.round(value);
        return Math.round(value);
    }
    return Math.round(value * 100) + '%';
}

function updateKnob(knob, value) {
    var param = knob.getAttribute('data-p');
    var min = parseFloat(knob.getAttribute('data-min'));
    var max = parseFloat(knob.getAttribute('data-max'));
    var isLog = knob.getAttribute('data-log') === '1';

    var norm;
    if (isLog && value > 0 && min > 0) {
        norm = (Math.log(value) - Math.log(min)) / (Math.log(max) - Math.log(min));
    } else {
        norm = (value - min) / (max - min);
    }
    if (norm < 0) norm = 0;
    if (norm > 1) norm = 1;

    var angle = -135 + norm * 270;
    var line = document.getElementById('line-' + param);
    if (line) {
        line.style.transform = 'rotate(' + angle + 'deg)';
        line.style.transformOrigin = 'center bottom';
    }

    var valEl = document.getElementById('val-' + param);
    if (valEl) {
        valEl.innerHTML = formatValue(param, value);
    }

    params[param] = value;
}

function initKnobs() {
    var knobs = document.querySelectorAll('.knob-mid');
    for (var i = 0; i < knobs.length; i++) {
        var knob = knobs[i];
        var val = parseFloat(knob.getAttribute('data-val'));
        updateKnob(knob, val);

        (function(k) {
            k.onmousedown = function(e) {
                e.preventDefault();
                dragging = k;
                dragStartY = e.clientY;
                var param = k.getAttribute('data-p');
                dragStartVal = params[param];
                if (dragStartVal === undefined) {
                    dragStartVal = parseFloat(k.getAttribute('data-val'));
                }
            };
            // Double-click to reset to default
            k.ondblclick = function(e) {
                e.preventDefault();
                var param = k.getAttribute('data-p');
                var defaultVal = parseFloat(k.getAttribute('data-val'));
                updateKnob(k, defaultVal);
                sendParam(param, defaultVal);
            };
        })(knob);
    }
}

// Initialize patch to defaults
function initPatch() {
    for (var param in defaultParams) {
        var val = defaultParams[param];
        var knob = document.getElementById('knob-' + param);
        if (knob) {
            updateKnob(knob, val);
        }
        sendParam(param, val);

        // Handle wave selectors
        if (param.indexOf('_wave') !== -1 || param === 'sub_octave' || param === 'noise_type' || param === 'reverb_type' || param === 'oversampling') {
            var sel = document.getElementById(param);
            if (sel) sel.value = val;
        }
    }
    // Reset wave buttons
    setWaveByValue('osc1_wave', 0);
    setWaveByValue('osc2_wave', 0);
    document.getElementById('preset-name').textContent = 'Init';
}

// Randomize parameters
function randomizePatch() {
    var randomizable = [
        'osc1_octave', 'osc1_semi', 'osc1_fine', 'osc1_pw', 'osc1_gain', 'osc1_pan',
        'osc2_octave', 'osc2_semi', 'osc2_fine', 'osc2_pw', 'osc2_gain', 'osc2_pan',
        'sub_level', 'noise_level',
        'filter_cutoff', 'filter_reso', 'filter_env', 'filter_key',
        'amp_a', 'amp_d', 'amp_s', 'amp_r',
        'flt_a', 'flt_d', 'flt_s', 'flt_r',
        'chorus_rate', 'chorus_depth', 'chorus_wet',
        'delay_time', 'delay_fdbk', 'delay_wet',
        'reverb_size', 'reverb_wet',
        'master_width'
    ];

    for (var i = 0; i < randomizable.length; i++) {
        var param = randomizable[i];
        var knob = document.getElementById('knob-' + param);
        if (knob) {
            var min = parseFloat(knob.getAttribute('data-min'));
            var max = parseFloat(knob.getAttribute('data-max'));
            var val = min + Math.random() * (max - min);
            var step = parseFloat(knob.getAttribute('data-step'));
            val = Math.round(val / step) * step;
            updateKnob(knob, val);
            sendParam(param, val);
        }
    }

    // Random waves
    var osc1Wave = Math.floor(Math.random() * 7);
    var osc2Wave = Math.floor(Math.random() * 7);
    setWaveByValue('osc1_wave', osc1Wave);
    setWaveByValue('osc2_wave', osc2Wave);
    sendParam('osc1_wave', osc1Wave);
    sendParam('osc2_wave', osc2Wave);

    document.getElementById('preset-name').textContent = 'Random';
}

function setWaveByValue(param, value) {
    var container = document.getElementById(param.replace('_wave', '-waves'));
    if (!container) return;
    var btns = container.getElementsByTagName('button');
    for (var i = 0; i < btns.length; i++) {
        btns[i].className = i === value ? 'wave-btn wave-btn-active' : 'wave-btn';
    }
}

document.onmousemove = function(e) {
    if (!dragging) return;

    var knob = dragging;
    var param = knob.getAttribute('data-p');
    var min = parseFloat(knob.getAttribute('data-min'));
    var max = parseFloat(knob.getAttribute('data-max'));
    var step = parseFloat(knob.getAttribute('data-step'));
    var isLog = knob.getAttribute('data-log') === '1';

    var delta = dragStartY - e.clientY;
    if (e.shiftKey) delta = delta * 0.1;
    var newVal;

    if (isLog && min > 0 && dragStartVal > 0) {
        var logMin = Math.log(min);
        var logMax = Math.log(max);
        var logStart = Math.log(dragStartVal);
        var logNew = logStart + delta * 0.01 * (logMax - logMin);
        if (logNew < logMin) logNew = logMin;
        if (logNew > logMax) logNew = logMax;
        newVal = Math.exp(logNew);
    } else {
        newVal = dragStartVal + delta * 0.01 * (max - min);
    }

    newVal = Math.round(newVal / step) * step;
    if (newVal < min) newVal = min;
    if (newVal > max) newVal = max;

    updateKnob(knob, newVal);
    sendParam(param, newVal);
};

document.onmouseup = function() {
    if (dragging) {
        dragging.classList.remove('dragging');
    }
    dragging = null;
};

// JUCE callback - only update if value actually changed (prevents reset during drag)
window.updateParameter = function(param, value) {
    // Don't update while user is dragging
    if (dragging) return;

    var knob = document.getElementById('knob-' + param);
    if (knob) {
        // Only update if value changed significantly (avoids floating point noise)
        var currentVal = params[param];
        if (currentVal === undefined || Math.abs(currentVal - value) > 0.0001) {
            updateKnob(knob, value);
        }
    }
};

// =================================================================
// OSCILLOSCOPE - Modern Canvas Implementation
// =================================================================
var scopeMode = 'wave';
var scopeCanvas, scopeCtx;
var scopeData = new Array(256).fill(0);      // Waveform data
var fftData = new Array(256).fill(0);         // FFT spectrum data
var scopePhase = 0;
var scopeAnimId = null;
var hasRealWaveData = false;
var hasRealFFTData = false;
var lastDataTime = 0;

function initScope() {
    scopeCanvas = document.getElementById('scope-canvas');
    if (!scopeCanvas) return;

    var container = scopeCanvas.parentElement;
    var dpr = window.devicePixelRatio || 1;

    // Set canvas size to match container
    var rect = container.getBoundingClientRect();
    scopeCanvas.width = rect.width * dpr;
    scopeCanvas.height = rect.height * dpr;
    scopeCanvas.style.width = rect.width + 'px';
    scopeCanvas.style.height = rect.height + 'px';

    scopeCtx = scopeCanvas.getContext('2d');
    scopeCtx.scale(dpr, dpr);

    // Start animation
    animateScope();
}

function getAccentColor() {
    return getComputedStyle(document.documentElement).getPropertyValue('--accent').trim() || '#00f5a0';
}

function getGlowColor() {
    return getComputedStyle(document.documentElement).getPropertyValue('--glow').trim() || 'rgba(0,245,160,0.4)';
}

function getBorderColor() {
    return getComputedStyle(document.documentElement).getPropertyValue('--border').trim() || '#3a3a4a';
}

function setScopeMode(mode) {
    scopeMode = mode;
    var btns = document.querySelectorAll('.scope-btn');
    btns.forEach(function(btn) {
        btn.classList.remove('active');
        if ((mode === 'wave' && btn.textContent === 'Wave') ||
            (mode === 'spectrum' && btn.textContent === 'FFT')) {
            btn.classList.add('active');
        }
    });
    // Show/hide frequency labels
    var freqLabels = document.getElementById('freq-labels');
    if (freqLabels) {
        freqLabels.style.display = mode === 'spectrum' ? 'flex' : 'none';
    }
}

function animateScope() {
    if (!scopeCtx) return;

    var w = scopeCanvas.width / (window.devicePixelRatio || 1);
    var h = scopeCanvas.height / (window.devicePixelRatio || 1);
    var accent = getAccentColor();
    var glow = getGlowColor();
    var border = getBorderColor();

    // Clear
    scopeCtx.fillStyle = 'transparent';
    scopeCtx.clearRect(0, 0, w, h);

    // Draw grid
    scopeCtx.strokeStyle = border;
    scopeCtx.lineWidth = 0.5;
    scopeCtx.globalAlpha = 0.3;

    // Horizontal grid lines
    for (var i = 0; i <= 4; i++) {
        var y = (h / 4) * i;
        scopeCtx.beginPath();
        scopeCtx.moveTo(0, y);
        scopeCtx.lineTo(w, y);
        scopeCtx.stroke();
    }

    // Vertical grid lines
    for (var j = 0; j <= 8; j++) {
        var x = (w / 8) * j;
        scopeCtx.beginPath();
        scopeCtx.moveTo(x, 0);
        scopeCtx.lineTo(x, h);
        scopeCtx.stroke();
    }

    // Center line (brighter)
    scopeCtx.globalAlpha = 0.5;
    scopeCtx.strokeStyle = accent;
    scopeCtx.beginPath();
    scopeCtx.moveTo(0, h / 2);
    scopeCtx.lineTo(w, h / 2);
    scopeCtx.stroke();

    scopeCtx.globalAlpha = 1;

    // Check if we have recent real data (within 500ms)
    var now = Date.now();
    var useRealData = (now - lastDataTime) < 500;

    // Generate demo waveform only if no real data
    if (!useRealData) {
        scopePhase += 0.05;
        for (var k = 0; k < 256; k++) {
            var t = k / 256;
            scopeData[k] = Math.sin(scopePhase + t * Math.PI * 4) * 0.5 +
                          Math.sin(scopePhase * 1.5 + t * Math.PI * 8) * 0.25 +
                          Math.sin(scopePhase * 0.7 + t * Math.PI * 2) * 0.15;
        }
        // Generate demo FFT from waveform
        for (var m = 0; m < 256; m++) {
            var freq = m / 256;
            fftData[m] = Math.abs(scopeData[m % 256]) * (1 - freq * 0.5) * Math.exp(-freq * 1.5) + 0.02;
        }
    }

    // Draw based on mode
    if (scopeMode === 'wave') {
        drawWaveform(w, h, accent, glow);
    } else if (scopeMode === 'spectrum') {
        drawSpectrum(w, h, accent, glow);
    }

    scopeAnimId = requestAnimationFrame(animateScope);
}

// Store previous waveform for trail effect
var prevWaveform = new Array(256).fill(0);
var waveTrailAlpha = 0.3;

function drawWaveform(w, h, accent, glow) {
    var cy = h / 2;
    var amp = h * 0.4;

    // Draw trail (previous waveform faded)
    scopeCtx.strokeStyle = accent;
    scopeCtx.lineWidth = 2;
    scopeCtx.globalAlpha = waveTrailAlpha * 0.3;
    scopeCtx.lineCap = 'round';
    scopeCtx.lineJoin = 'round';

    scopeCtx.beginPath();
    for (var t = 0; t < 256; t++) {
        var tx = (t / 255) * w;
        var ty = cy - prevWaveform[t] * amp;
        if (t === 0) scopeCtx.moveTo(tx, ty);
        else scopeCtx.lineTo(tx, ty);
    }
    scopeCtx.stroke();

    // Outer glow layer
    scopeCtx.lineWidth = 6;
    scopeCtx.globalAlpha = 0.15;

    scopeCtx.beginPath();
    for (var i = 0; i < 256; i++) {
        var x = (i / 255) * w;
        var y = cy - scopeData[i] * amp;
        if (i === 0) scopeCtx.moveTo(x, y);
        else scopeCtx.lineTo(x, y);
    }
    scopeCtx.stroke();

    // Middle glow layer
    scopeCtx.lineWidth = 4;
    scopeCtx.globalAlpha = 0.25;

    scopeCtx.beginPath();
    for (var g = 0; g < 256; g++) {
        var gx = (g / 255) * w;
        var gy = cy - scopeData[g] * amp;
        if (g === 0) scopeCtx.moveTo(gx, gy);
        else scopeCtx.lineTo(gx, gy);
    }
    scopeCtx.stroke();

    // Main line
    scopeCtx.lineWidth = 2;
    scopeCtx.globalAlpha = 1;
    scopeCtx.shadowColor = accent;
    scopeCtx.shadowBlur = 12;

    scopeCtx.beginPath();
    for (var j = 0; j < 256; j++) {
        var xx = (j / 255) * w;
        var yy = cy - scopeData[j] * amp;
        if (j === 0) scopeCtx.moveTo(xx, yy);
        else scopeCtx.lineTo(xx, yy);
    }
    scopeCtx.stroke();
    scopeCtx.shadowBlur = 0;

    // Update trail
    for (var p = 0; p < 256; p++) {
        prevWaveform[p] = prevWaveform[p] * 0.7 + scopeData[p] * 0.3;
    }
}

function drawSpectrum(w, h, accent, glow) {
    var binCount = 128;
    var barWidth = w / binCount;
    var maxH = h - 4;

    scopeCtx.shadowColor = accent;
    scopeCtx.shadowBlur = 3;

    for (var j = 0; j < binCount; j++) {
        // Use the real FFT data (downsampled from 256 to 128 bins)
        var idx = Math.floor(j * 2);
        var val = fftData[idx] || 0;
        var barH = val * maxH;
        if (barH < 1) barH = 1;

        // Update peak hold
        if (val > spectrumPeaks[j]) {
            spectrumPeaks[j] = val;
        } else {
            spectrumPeaks[j] *= spectrumPeakDecay;
        }

        var x = j * barWidth;
        var y = h - barH - 2;

        // Color intensity based on magnitude
        scopeCtx.fillStyle = accent;
        scopeCtx.globalAlpha = 0.4 + val * 0.6;
        scopeCtx.fillRect(x, y, barWidth - 0.5, barH);

        // Draw peak hold line
        var peakY = h - spectrumPeaks[j] * maxH - 2;
        scopeCtx.globalAlpha = 0.8;
        scopeCtx.fillRect(x, peakY, barWidth - 0.5, 2);
    }

    scopeCtx.shadowBlur = 0;
    scopeCtx.globalAlpha = 1;
}

// JUCE pushes waveform data via this function
window.updateWaveformData = function(data) {
    if (data && data.length) {
        for (var i = 0; i < Math.min(data.length, 256); i++) {
            scopeData[i] = data[i];
        }
        hasRealWaveData = true;
        lastDataTime = Date.now();
    }
};

// JUCE pushes FFT spectrum data via this function
window.updateScopeData = function(data) {
    if (data && data.length) {
        for (var i = 0; i < Math.min(data.length, 256); i++) {
            fftData[i] = data[i];
        }
        hasRealFFTData = true;
        lastDataTime = Date.now();
    }
};

window.onload = function() {
    initKnobs();
    setTheme('celestial');
    initScope();
    startFXActiveCheck();
    startMeterAnimation();
};

// Handle resize
window.onresize = function() {
    if (scopeAnimId) cancelAnimationFrame(scopeAnimId);
    initScope();
};

// =================================================================
// FX ACTIVE GLOW
// =================================================================
function startFXActiveCheck() {
    setInterval(function() {
        checkFXActive('exciter_mix', 0);
        checkFXActive('chorus_wet', 1);
        checkFXActive('delay_wet', 2);
        checkFXActive('reverb_wet', 3);
    }, 100);
}

function checkFXActive(param, panelIndex) {
    var val = params[param] || 0;
    var panels = document.querySelectorAll('.panel');
    // FX panels are in the effects row - find by fx-title
    var fxPanels = [];
    panels.forEach(function(p) {
        if (p.querySelector('.fx-title')) fxPanels.push(p);
    });
    if (fxPanels[panelIndex]) {
        if (val > 0.01) {
            fxPanels[panelIndex].classList.add('fx-active');
        } else {
            fxPanels[panelIndex].classList.remove('fx-active');
        }
    }
}

// =================================================================
// LEVEL METERS
// =================================================================
var meterLevelL = 0, meterLevelR = 0;
var meterPeakL = 0, meterPeakR = 0;
var meterPeakHoldL = 0, meterPeakHoldR = 0;

function startMeterAnimation() {
    animateMeters();
}

function animateMeters() {
    // Decay current levels
    meterLevelL *= 0.85;
    meterLevelR *= 0.85;

    // Decay peak hold
    meterPeakHoldL--;
    meterPeakHoldR--;
    if (meterPeakHoldL <= 0) meterPeakL *= 0.95;
    if (meterPeakHoldR <= 0) meterPeakR *= 0.95;

    // Update DOM
    var fillL = document.getElementById('meter-l');
    var fillR = document.getElementById('meter-r');
    var peakLEl = document.getElementById('peak-l');
    var peakREl = document.getElementById('peak-r');

    if (fillL) fillL.style.height = (meterLevelL * 100) + '%';
    if (fillR) fillR.style.height = (meterLevelR * 100) + '%';
    if (peakLEl) peakLEl.style.bottom = (meterPeakL * 100) + '%';
    if (peakREl) peakREl.style.bottom = (meterPeakR * 100) + '%';

    requestAnimationFrame(animateMeters);
}

// JUCE can call this to update meter levels
window.updateMeterLevels = function(left, right) {
    meterLevelL = Math.max(meterLevelL, Math.abs(left));
    meterLevelR = Math.max(meterLevelR, Math.abs(right));

    if (meterLevelL > meterPeakL) {
        meterPeakL = meterLevelL;
        meterPeakHoldL = 30; // Hold for 30 frames
    }
    if (meterLevelR > meterPeakR) {
        meterPeakR = meterLevelR;
        meterPeakHoldR = 30;
    }
};

// =================================================================
// MIDI ACTIVITY
// =================================================================
var midiLedTimeout = null;

window.midiActivity = function() {
    var led = document.getElementById('midi-led');
    if (led) {
        led.classList.add('active');
        if (midiLedTimeout) clearTimeout(midiLedTimeout);
        midiLedTimeout = setTimeout(function() {
            led.classList.remove('active');
        }, 100);
    }
};

// =================================================================
// VOICE COUNT
// =================================================================
window.updateVoiceCount = function(active, total) {
    var el = document.getElementById('voice-count');
    if (el) {
        el.textContent = active + '/' + total;
    }
};
</script>

</body>
</html>